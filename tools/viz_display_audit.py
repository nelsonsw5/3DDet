scene_data = [{'upc': '818094005777',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.2110433280467987,
   'y': -0.15601402521133423,
   'z': -0.19092947244644165},
  'quantity': 6,
  'confidence': 0.8571581840515137,
  'dimensions': {'x': 0.09343475103378296,
   'y': 0.16350924968719482,
   'z': 0.0}},
 {'upc': '818094005777',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.13486860692501068,
   'y': -0.15853095054626465,
   'z': -0.1901559680700302},
  'quantity': 6,
  'confidence': 0.8989095687866211,
  'dimensions': {'x': 0.07776474952697754,
   'y': 0.15579725801944733,
   'z': 0.0}},
 {'upc': '818094005753',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.06312471628189087,
   'y': -0.1597088724374771,
   'z': -0.18360841274261475},
  'quantity': 6,
  'confidence': 0.89031982421875,
  'dimensions': {'x': 0.07762962579727173,
   'y': 0.14996032416820526,
   'z': 0.0}},
 {'upc': '818094005753',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.01368597149848938,
   'y': -0.15843042731285095,
   'z': -0.16567431390285492},
  'quantity': 6,
  'confidence': 0.8884763717651367,
  'dimensions': {'x': 0.06925937533378601, 'y': 0.1440218836069107, 'z': 0.0}},
 {'upc': '818094005746',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.08395534008741379,
   'y': -0.15687577426433563,
   'z': -0.1569824367761612},
  'quantity': 6,
  'confidence': 0.8323421478271484,
  'dimensions': {'x': 0.07391330599784851,
   'y': 0.14595046639442444,
   'z': 0.0}},
 {'upc': '818094005791',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.18140855431556702,
   'y': -0.16950783133506775,
   'z': -0.48921725153923035},
  'quantity': 1,
  'confidence': 0.8289909362792969,
  'dimensions': {'x': 0.07373327016830444,
   'y': 0.16346201300621033,
   'z': 0.0}},
 {'upc': '818094008402',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.22015288472175598,
   'y': -0.16037575900554657,
   'z': -0.21370862424373627},
  'quantity': 6,
  'confidence': 0.5253796577453613,
  'dimensions': {'x': 0.05327582359313965,
   'y': 0.15980948507785797,
   'z': 0.0}},
 {'upc': '818094005784',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.326053649187088,
   'y': -0.15991030633449554,
   'z': -0.19700884819030762},
  'quantity': 5,
  'confidence': 0.8227825164794922,
  'dimensions': {'x': 0.05623340606689453,
   'y': 0.16140693426132202,
   'z': 0.0}},
 {'upc': '818094005784',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.39171361923217773,
   'y': -0.1611032485961914,
   'z': -0.21412178874015808},
  'quantity': 5,
  'confidence': 0.8448057174682617,
  'dimensions': {'x': 0.07884377241134644,
   'y': 0.17246566712856293,
   'z': 0.0}},
 {'upc': '070847811169',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.21189150214195251,
   'y': -0.36991700530052185,
   'z': -0.1652209609746933},
  'quantity': 5,
  'confidence': 0.8740301132202148,
  'dimensions': {'x': 0.0756341814994812, 'y': 0.1750447154045105, 'z': 0.0}},
 {'upc': '070847811169',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.13705268502235413,
   'y': -0.3637668192386627,
   'z': -0.14215806126594543},
  'quantity': 6,
  'confidence': 0.883244514465332,
  'dimensions': {'x': 0.07631893455982208,
   'y': 0.15997955203056335,
   'z': 0.0}},
 {'upc': '070847010463',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.06676575541496277,
   'y': -0.3715401589870453,
   'z': -0.1485072821378708},
  'quantity': 6,
  'confidence': 0.5068564414978027,
  'dimensions': {'x': 0.07902286946773529, 'y': 0.1618039309978485, 'z': 0.0}},
 {'upc': '070847029014',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.005420338362455368,
   'y': -0.3666209578514099,
   'z': -0.1488816887140274},
  'quantity': 6,
  'confidence': 0.8660681247711182,
  'dimensions': {'x': 0.07647958397865295,
   'y': 0.16669851541519165,
   'z': 0.0}},
 {'upc': '611269818994',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.07422016561031342,
   'y': -0.38779816031455994,
   'z': -0.20005324482917786},
  'quantity': 5,
  'confidence': 0.8378763198852539,
  'dimensions': {'x': 0.06629350781440735, 'y': 0.1732531487941742, 'z': 0.0}},
 {'upc': '611269818994',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.13483896851539612,
   'y': -0.3731918931007385,
   'z': -0.14355239272117615},
  'quantity': 5,
  'confidence': 0.90362548828125,
  'dimensions': {'x': 0.06405854225158691,
   'y': 0.15245956182479858,
   'z': 0.0}},
 {'upc': '611269818994',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.20092469453811646,
   'y': -0.37837010622024536,
   'z': -0.16582250595092773},
  'quantity': 7,
  'confidence': 0.8714923858642578,
  'dimensions': {'x': 0.06650108098983765,
   'y': 0.16727781295776367,
   'z': 0.0}},
 {'upc': '611269818994',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.26247522234916687,
   'y': -0.37466394901275635,
   'z': -0.15715079009532928},
  'quantity': 6,
  'confidence': 0.8723082542419434,
  'dimensions': {'x': 0.06895685195922852, 'y': 0.1692761778831482, 'z': 0.0}},
 {'upc': '611269332827',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.32441413402557373,
   'y': -0.3697647154331207,
   'z': -0.1320071816444397},
  'quantity': 1,
  'confidence': 0.6828818321228027,
  'dimensions': {'x': 0.07439756393432617,
   'y': 0.15927201509475708,
   'z': 0.0}},
 {'upc': '611269332827',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.39020824432373047,
   'y': -0.3711986839771271,
   'z': -0.12990984320640564},
  'quantity': 2,
  'confidence': 0.6488802433013916,
  'dimensions': {'x': 0.07589972019195557,
   'y': 0.16788294911384583,
   'z': 0.0}},
 {'upc': '012000028496',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.12651684880256653,
   'y': -0.6164897084236145,
   'z': -0.15308189392089844},
  'quantity': 2,
  'confidence': 0.8554458618164062,
  'dimensions': {'x': 0.07690630853176117,
   'y': 0.14901567995548248,
   'z': 0.0}},
 {'upc': '012000028496',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.05642849579453468,
   'y': -0.6179320812225342,
   'z': -0.15816207230091095},
  'quantity': 2,
  'confidence': 0.8884010314941406,
  'dimensions': {'x': 0.07432705163955688,
   'y': 0.14524905383586884,
   'z': 0.0}},
 {'upc': '012000028458',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.02520172856748104,
   'y': -0.618762731552124,
   'z': -0.15411531925201416},
  'quantity': 2,
  'confidence': 0.9027607440948486,
  'dimensions': {'x': 0.06828022003173828,
   'y': 0.14076381921768188,
   'z': 0.0}},
 {'upc': '012000028458',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.09459851682186127,
   'y': -0.618120014667511,
   'z': -0.1430647373199463},
  'quantity': 2,
  'confidence': 0.911005973815918,
  'dimensions': {'x': 0.0672944188117981, 'y': 0.14057016372680664, 'z': 0.0}},
 {'upc': '898999010007',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.31885775923728943,
   'y': -0.6192162036895752,
   'z': -0.18573836982250214},
  'quantity': 6,
  'confidence': 0.7801816463470459,
  'dimensions': {'x': 0.08441579341888428, 'y': 0.169972762465477, 'z': 0.0}},
 {'upc': '898999010007',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.3841838240623474,
   'y': -0.6160695552825928,
   'z': -0.12251804023981094},
  'quantity': 7,
  'confidence': 0.750434398651123,
  'dimensions': {'x': 0.11046695709228516, 'y': 0.1709478348493576, 'z': 0.0}},
 {'upc': '610764863812',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.21709463000297546,
   'y': -0.8858003616333008,
   'z': -0.1490178257226944},
  'quantity': 6,
  'confidence': 0.6478636264801025,
  'dimensions': {'x': 0.0765542984008789, 'y': 0.1680009365081787, 'z': 0.0}},
 {'upc': '610764863430',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.15105746686458588,
   'y': -0.8834516406059265,
   'z': -0.14109262824058533},
  'quantity': 7,
  'confidence': 0.8081793785095215,
  'dimensions': {'x': 0.08105121552944183, 'y': 0.1674301028251648, 'z': 0.0}},
 {'upc': '610764028495',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.08033323287963867,
   'y': -0.8980768918991089,
   'z': -0.17895439267158508},
  'quantity': 6,
  'confidence': 0.8108139038085938,
  'dimensions': {'x': 0.07966506481170654,
   'y': 0.18070891499519348,
   'z': 0.0}},
 {'upc': '610764024220',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': -0.009536086581647396,
   'y': -0.9038947224617004,
   'z': -0.20284324884414673},
  'quantity': 6,
  'confidence': 0.6765151023864746,
  'dimensions': {'x': 0.076515793800354, 'y': 0.1871100664138794, 'z': 0.0}},
 {'upc': '858176002065',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.06519287824630737,
   'y': -0.8804823756217957,
   'z': -0.1436401605606079},
  'quantity': 6,
  'confidence': 0.7823410034179688,
  'dimensions': {'x': 0.0748170018196106, 'y': 0.18220365047454834, 'z': 0.0}},
 {'upc': '858176002065',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.1364011913537979,
   'y': -0.8802597522735596,
   'z': -0.13831031322479248},
  'quantity': 5,
  'confidence': 0.7775943279266357,
  'dimensions': {'x': 0.07438942790031433,
   'y': 0.18267884850502014,
   'z': 0.0}},
 {'upc': '858176002270',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.2152194380760193,
   'y': -0.8808143138885498,
   'z': -0.14225275814533234},
  'quantity': 5,
  'confidence': 0.7995820045471191,
  'dimensions': {'x': 0.08222317695617676,
   'y': 0.19047483801841736,
   'z': 0.0}},
 {'upc': '052000324815',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.2964170277118683,
   'y': -0.87630695104599,
   'z': -0.137282133102417},
  'quantity': 6,
  'confidence': 0.8014755249023438,
  'dimensions': {'x': 0.09002119302749634,
   'y': 0.20546022057533264,
   'z': 0.0}},
 {'upc': '052000324815',
  'normal': {'x': 0.0, 'y': 0.0, 'z': 1.0},
  'centroid': {'x': 0.3823223412036896,
   'y': -0.8788396120071411,
   'z': -0.13560059666633606},
  'quantity': 6,
  'confidence': 0.8259701728820801,
  'dimensions': {'x': 0.0984799861907959, 'y': 0.21821492910385132, 'z': 0.0}}]

obj_path = "pointcloud.obj"


from pytorch3d.io import load_obj
import numpy as np
import torch
import pdb
#from wandb_utils.wandb import WandB
#pdb.set_trace()
from wandb_utils.wandb import WandB
from transforms import NormalizeShift, NegZForward2YForward, MirrorX
from features.points_to_beams import BeamFeatures

centroids = []
dims = []
normals = []
labels = []

for scene_dict in scene_data:
    if "dimensions" not in scene_dict:
        continue
    labels.append(f"upc:{scene_dict['upc']}\ngt:{scene_dict['quantity']}")
    centroids.append(
        [scene_dict["centroid"]["x"], scene_dict["centroid"]["y"], scene_dict["centroid"]["z"]]
    )
    dims.append(
        [scene_dict["dimensions"]["x"],  scene_dict["dimensions"]["y"], scene_dict["dimensions"]["z"]]
    )
    normals.append(
        [scene_dict["normal"]["x"], scene_dict["normal"]["y"], scene_dict["normal"]["z"]]
    )

#loaded_obj = load_obj(obj_path)

#pdb.set_trace()

# print("centroids: ", centroids)
centroids = torch.tensor(centroids)
dims = torch.tensor(dims)
normals = torch.tensor(normals)
#pdb.set_trace()


run = WandB(
    project='neonet-viz_audit',
    enabled=True,
    log_objects=True
)


pc, _, _ = load_obj(obj_path)
swap = NegZForward2YForward()
norm = NormalizeShift()

# normalize point cloud
pc = norm.fit_transform(pc)
centroids = norm(centroids)
dims = norm.scale(dims)
normals = norm.scale(normals)
#pdb.set_trace()
# swap axes
pc = swap(pc)
centroids = swap(centroids)
dims = swap(dims)
normals = swap(normals) / 10.0

# get beams
beam_feats = BeamFeatures(
            beam_dim=1, # assumed to be in -Z forward (App) space
            max_voxels=centroids.shape[0],
            max_points=1024,
            epsilon=0.05,
            augmented=False,
            with_distance=False,
            zero_pad=True
)

#print("pc: ", pc)
#print("centroids: ", centroids)
#print("dims: ", dims)

feats, _, _ = beam_feats(
    points=pc,
    centroids=centroids,
    dimensions=dims
)

# get feature RGB
n, d, c = feats.shape  # centroids, dimension, channels
feats = torch.flatten(feats, start_dim=0, end_dim=1)

f_colors = []
for i in range(n):
    color = np.random.randint(0, 255, size=3).reshape(1, 3)
    rgb_i = np.repeat(color, d, axis=0)
    f_colors.append(rgb_i)
f_colors = np.concatenate(f_colors)
feats_rgb = np.concatenate([feats, f_colors], axis=1)


# get pseudo boxes for normal viz
shifted_centroids= centroids + normals
#midpoints = centroids + normals/2.0


pc = pc.data.numpy()
rgb = run.get_rgb_point_heatmap(pc)
# print("centroids: ", centroids)
# print("dims: ", dims)
boxes = run.get_bb_dict(centroids, dims, labels=labels)
c = [[255, 255, 0]]*shifted_centroids.shape[0]
boxes2 = run.get_bb_dict(shifted_centroids, dims, colors=c)

boxes = np.concatenate([boxes, boxes2], axis=0)

# Fetch points (with associated colors) for logging in W&B later
points_rgb = np.array([[p[0], p[1], p[2], c[0], c[1], c[2]] for p, c in zip(pc, rgb)])

pc_dict = run.get_point_cloud_log(points_rgb, boxes=boxes)

pc_feats_dict = run.get_point_cloud_log(
                points=feats_rgb,
                boxes=np.array(boxes),
                key="Point Features"
            )

#img_dict = run.get_img_log(
#    [
#       "/home/porter/data/display-audits/12-29-21/med/scene-4/img-2.jpg",
#        "/home/porter/data/display-audits/12-29-21/med/scene-4/img-1.jpg"
#
#]
#)
pdb.set_trace()
dict_list = [pc_dict, pc_feats_dict]
#img_dict]

log_dict = {}
for d in dict_list:
    for k, v in d.items():
        log_dict[k] = v

run.log(log_dict)
